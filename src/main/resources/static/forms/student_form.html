<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <title>高校信息管理系统</title>
    <link rel="stylesheet" href="../layui/css/layui.css">
    <script src="../layui/layui.js"></script>
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
</head>

<body>
<form class="layui-form" id="form_demo" lay-filter="form1">
    <!-- 提示：如果你不想用form，你可以换成div等任何一个普通元素 -->
    <div id="edit">
        <div class="layui-form-item">
            <label class="layui-form-label">学号</label>
            <div class="layui-input-block">
                <input id="studentId" type="text" name="studentId" placeholder="请输入" autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">证件类型</label>
            <div class="layui-input-block">
                <select name="studentPersonIdType">
                    <option value="身份证">身份证</option>
                    <option value="护照">护照</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">证件号码</label>
            <div class="layui-input-block">
                <input type="text" lay-verify="identity" name="studentPersonId" placeholder="请输入证件号码" autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">姓名</label>
            <div class="layui-input-block">
                <input type="text" name="studentName" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">性别</label>
            <div class="layui-input-block">
                <input type="radio" name="studentSex" value="男" title="男">
                <input type="radio" name="studentSex" value="女" title="女" checked>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">生日</label>
            <div class="layui-input-block">
                <input id="date1" lay-verify="date" type="text" name="studentBirthday" placeholder="请输入"
                       autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">国籍</label>
            <div class="layui-input-block">
                <input type="text" name="studentCountry" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">手机号</label>
            <div class="layui-input-block">
                <input type="text" lay-verify="phone" name="studentPhoneNumber" placeholder="请输入" autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">住址</label>
            <div class="layui-input-block">
                <input type="text" name="studentAddress" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">邮编</label>
            <div class="layui-input-block">
                <input type="text" lay-verify="number" name="studentPC" placeholder="请输入" autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">入学时间</label>
            <div class="layui-input-block">
                <input id="date2" lay-verify="date" type="text" name="studentStartYear" placeholder="请输入"
                       autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">邮箱</label>
            <div class="layui-input-block">
                <input type="text" lay-verify="email" name="studentEmail" placeholder="请输入" autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">班级ID</label>
            <div class="layui-input-block">
                <input id="clazzId" type="text" name="studentClazzId" placeholder="请输入" autocomplete="off"
                       class="layui-input">
            </div>
        </div>
    </div>
    <div id="downgrade">
        <div class="layui-form-item">
            <label class="layui-form-label">异动ID</label>
            <div class="layui-input-block">
                <input id="changeId" type="text" name="id" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">原班级ID</label>
            <div class="layui-input-block">
                <input id="clazzId0" type="text" name="lastClazzId" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">现班级ID</label>
            <div class="layui-input-block">
                <input id="clazzId1" type="text" name="nowClazzId" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">学号</label>
            <div class="layui-input-block">
                <input id="studentId" type="text" name="student.studentId" placeholder="请输入" autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">降级原因</label>
            <div class="layui-input-block">
                <input type="text" name="cause" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">异动时间</label>
            <div class="layui-input-block">
                <input id="date1" lay-verify="date" type="text" name="date" placeholder="请输入"
                       autocomplete="off"
                       class="layui-input">
            </div>
        </div>
    </div>
    <div id="switchmajor">
        <div class="layui-form-item">
            <label class="layui-form-label">异动ID</label>
            <div class="layui-input-block">
                <input id="changeId" type="text" name="id" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">原班级ID</label>
            <div class="layui-input-block">
                <input id="clazzId0" type="text" name="lastClazzId" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">现班级ID</label>
            <div class="layui-input-block">
                <input id="clazzId1" type="text" name="nowClazzId" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">学号</label>
            <div class="layui-input-block">
                <input id="studentId" type="text" name="student.studentId" placeholder="请输入" autocomplete="off"
                       class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">是否是团员</label>
            <div class="layui-input-block">
                <input type="radio" name="member" value="是" title="是">
                <input type="radio" name="member" value="否" title="否" checked>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">异动时间</label>
            <div class="layui-input-block">
                <input id="date2" lay-verify="date" type="text" name="date" placeholder="请输入"
                       autocomplete="off"
                       class="layui-input">
            </div>
        </div>

    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="submit_button">提交</button>
            <button id="reset-btn" class="layui-btn layui-btn-primary">重置</button>
        </div>
    </div>
</form>
</body>

<script>
    layui.use(['form', 'element', 'laydate'], function () {
        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) {
                    return pair[1];
                }
            }
            return (false);
        }
        function getOriginDate() {
            $.ajax({
                type: 'POST',
                url: get_list_url,
                async: false,
                data: {
                    page: 1,
                    limit: 5,
                    studentId: id
                },
                success: function (result) {
                    originData = result.rows[0];
                    form.val("form1", originData);
                }
            });
        }

        var submit_url, get_list_url;
        var originData;
        var op = getQueryVariable("op");
        var id = getQueryVariable("id");
        var op1 = ""; // 根据异动记录是否存在决定add/edit
        var form = layui.form;
        var laydate = layui.laydate;

        // 设置接口url
        if (op === 'add' || op === 'edit') {
            get_list_url = "../student/get_list";
            submit_url = "/student/" + op;
        } else if (op === 'downgrade') {
            $.ajax({
                type: 'POST',
                url: "../down_grade/find",
                async: false, // 设置ajax为同步
                data: {
                    studentId: id
                },
                success: function (result) {
                    if (result.status === "yes") { // 已存在异动记录,则接下来操作是edit
                        op1 = "edit";
                        get_list_url = "../down_grade/get_list";
                        submit_url = "/down_grade/edit";
                    } else if (result.status === "no"){ // 不存在异动记录，则接下来操作时add
                        op1 = "add";
                        get_list_url = "../student/get_list";
                        submit_url = "/down_grade/add";
                    }
                }
            });
        } else if (op === 'switchmajor') {
            $.ajax({
                type: 'POST',
                async: false,
                url: "../switch_major/find",
                data: {
                    studentId: id
                },
                success: function (result) {
                    if (result.status === "yes") { // 已存在异动记录,则接下来操作是edit
                        op1 = "edit";
                        get_list_url = "../switch_major/get_list";
                        submit_url = "/switch_major/edit";
                    } else if (result.status === "no"){ // 不存在异动记录，则接下来操作时add
                        op1 = "add";
                        get_list_url = "../student/get_list";
                        submit_url = "/switch_major/add";
                    }
                }
            });
        }
        // 根据参数渲染页面
        switch (op) {
            case 'add':
            case 'edit':
                $("#downgrade, #switchmajor").remove();
                getOriginDate();
                $("#idInput").attr("readonly", "readonly");
                if(op === 'edit')
                    $("#clazzId").attr("readonly", "readonly");
                break;
            case 'downgrade':
                $("#edit, #switchmajor").remove();
                getOriginDate();
                if(op1 === "add"){
                    form.val("form1", {"student.studentId": id, "lastClazzId": originData.studentClazzId});
                } else if(op1 === "edit"){
                    form.val("form1", {"student.studentId": id});
                    $("#changeId, #clazzId1").attr("readonly", "readonly");
                }
                $("#studentId, #clazzId0").attr("readonly", "readonly");
                break;
            case 'switchmajor':
                $("#edit, #downgrade").remove();
                getOriginDate();
                if(op1 === "add"){
                    form.val("form1", {"student.studentId": id, "lastClazzId": originData.studentClazzId});
                } else if(op1 === "edit"){
                    form.val("form1", {"student.studentId": id});
                    $("#changeId, #clazzId1").attr("readonly", "readonly");
                }
                $("#studentId, #clazzId0").attr("readonly", "readonly");
                break;
        }
        laydate.render({
            elem: '#date1'
        });
        laydate.render({
            elem: '#date2'
        });
        form.on('submit(submit_button)', function (data) {
            $.ajax({
                type: "post",
                url: submit_url,
                async: false,
                data: data.field,
                success: function (result) {
                    if (result.type == "success") {
                        layer.msg(result.msg);
                        originData = data.field;
                        return;
                    } else {
                        layer.msg(result.msg);
                        return;
                    }
                }
            })
            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        });
        if (op === "edit" || op == "downgrade" || op === "switchmajor") {
            $("#reset-btn").click(function (e) {
                e.preventDefault();
                form.val("form1", originData);
            });
        }
    });
</script>

</html>
